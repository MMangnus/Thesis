\section{Introduction}
Investigation of the BOLD response with functional MRI at the level of the cortical layers has become increasingly popular over the the last decade \cite{Dumoulin2017,Trampel2017}. Activation levels differ at the laminar scale \cite{Koopmans2011} and they can vary depending on the performed task \cite{Muckli2015,Kok2016}. Laminar signals have the potential to reveal information about the underlying neuronal processes within a cortical region, as the signal from different layers may be associated with feed forward or feedback signals \cite{Felleman1991,Self2017}. However, layer specific analysis comes with great methodological challenges.

The thickness of the cerebral cortex varies between 1 and 4.5 millimetres \cite{Zilles1990,Fischl2000}. Identifying individual layers therefore ideally requires sub-millimetre resolution, at the cost of signal to noise ratio (SNR) per voxel. On top of this, a functional experiment ideally requires a Repetition Time (TR) on the order of several seconds. Layer specific investigations are hence best conducted at higher field ($\ge$7 Tesla) for improved SNR, but high field strength also have some disadvantages \cite{Poser2017}. The inhomogeneities of the static magnetic field $B_0$ can cause non-linear distortions when a fast acquisition scheme like Echo Planar Imaging (EPI) is used \cite{Mansfield1977}. Distortions primarily present themselves in the phase-encoding direction as a function of the bandwidth per pixel and static field strength \cite{Schmitt1998}. As layer specific analysis requires high spatial precision, non-linear distortions are particularly problematic. $T_2^*$-weighted images usually have insufficient contrast to segment the cortical grey matter, so instead one needs to identify the cortical boundaries from a different scan. This is typically a high-contrast $T_1$-weighted anatomical scan that can be segmented with tools such as FreeSurfer \cite{Dale1999}, CBS Tools \cite{Bazin2014}, or BrainVoyager \cite{Goebel2012}. However, as the anatomical scan is undistorted, it may not sufficiently overlap with the functional scan. 

Several potential solutions have been proposed for providing accurate alignment of functional images with an anatomical image. Early papers circumvent the problem by segmenting only a small piece of straight cortex \cite{Ress2007,Koopmans2010}. It is also possible to resort to different acquisition schemes like FLASH, which do not suffer significant distortions, but at a heavy cost in temporal resolution. Koopmans et al. combine this with a vertex based realignment procedure based on the Stripe of Gennari \cite{Koopmans2011}. This approach, however, is highly specific to parts of the primary visual cortex that show a myelinated band in the middle of the cortex (Stripe of Gennari), and does not generalise to the rest of the brain. Yet another alternative is to acquire an anatomical image with the same EPI readout and field of view as the functional image, such that the two volumes are similarly distorted \cite{Kashyap2017}. However, this (often unjustly) assumes that field inhomogeneities, and with it the distortions, do not change between acquisitions. Additionally, if the acquisition only covers a small part of the brain, cortical reconstruction algorithms may easily fail, as they are often based on whole-brain templates.

Ideally, there would be an accurate cross-contrast ($T_1$ to $T_2^*$) registration algorithm, but this is a notoriously hard problem. The combination of the warping of images and the unknown relation between contrasts creates a vast parameter space that is difficult to solve in a coregistration procedure. While algorithms like AFNI's \texttt{3dQWarp} \cite{Cox1996} technically support cross-modal cost functions, the documentation acknowledges that such usage is rather experimental and in our experience indeed does not reach submillimetre accuracy. In general, no algorithm currently exists that corrects non-linear distortions in high resolution low-contrast images up to the laminar specific level, and works either on partial or whole-brain images.

One way to search through relevant information in the image domain is to try and detect the grey-white matter boundary and match this between volumes. This is using \emph{geometric} information on top of \emph{volumetric} information and forms the basis of Boundary Based Registration (BBR) \cite{Greve2009}. A three-dimensional cortical reconstruction of the grey-white matter boundary is created on a high contrast anatomical image and serves as a basis for the coregistration. While a functional image is too low in contrast for generating a cortical reconstruction, it can be used in the registration procedure. The contrast is sufficient to optimise the average contrast across the boundary in order to achieve a better realignment. This was proposed for linear registrations and proven to be an exceedingly robust method. We here extend BBR to work recursively and effectively produce a cross-contrast non-linear registration. Our aim was to provide accurate submillimetre registration for whole-brain or partial brain images. The algorithms can be performed on the the functional data, without additional acquisition of additional scans, and without reinterpolation as a result of a non-linear warping. Importantly, the procedure produces a smooth deformation field that does not alter the topological properties of the mesh, such that the resulting surfaces can naturally be used in subsequent automatic layering and further layer specific analyes \cite{Waehnert2014,Leprince2015}.
