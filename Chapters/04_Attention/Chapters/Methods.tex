\section{Methods}
\subsection{Participants}
Nineteen healthy adults (aged 22-27, eight female), with normal or corrected-to-normal vision, participated in this study. All participants provided written informed consent in accordance with the guidelines of the local ethics committee. Two subjects were excluded from analysis; one subject was excluded due to insufficient (chance-level) performance on the attention task, and another due to weak retinotopic maps. The remaining data from 17 subjects were analyzed.

\subsection{Experimental design and stimuli}
Observers viewed the visual display through a mirror mounted on the head coil. Visual stimuli were generated by a Macbook Pro computer running MATLAB and Psychophysics Toolbox software \cite{Brainard1997,Pelli1997} and displayed on a rear-projection screen using a luminance-calibrated EIKI projector (resolution 1,024 X 768 pixels, refresh rate 60 Hz).

Participants were required to maintain fixation on a central bull's eye target (radius: 0.25\textdegree) throughout each experimental run. Each run consisted of an initial fixation period (3000 ms) followed by 32 stimulus trials (average duration: 4.7 seconds). Trials were separated by inter-trial intervals of variable duration (1000-2500 ms, uniformly distributed across trials). Each trial started with the presentation of a central attention cue (800 ms). This was followed by a delay period of variable duration (0-5000 ms; drawn from an exponential distribution to ensure a constant hazard rate), after which the two orientation stimuli appeared on the screen (500 ms). The orientation stimuli were followed by a response window (1300 ms), in which the fixation target turned orange.

Stimuli were two counterphasing sinusoidal gratings of independent orientation (\textasciitilde 45\textdegree~or \textasciitilde 135\textdegree; size: 7\textdegree; spatial frequency: 1 cycle per \textdegree; randomized spatial phase; contrast: 50\%; contrast decreased linearly to 0 towards the edge of the stimulus over the last degree), centered at 5\textdegree~to the left and right of fixation. We used a compound white/black cue consisting of two dots (dot size 0.25\textdegree) that straddled the fixation point (0.8\textdegree~to the left and right of fixation) to indicate with 100\% validity which of the two gratings should be attended \cite{Jehee2011}). Subjects were instructed to attend to the same side of fixation as either the white or black dot in the compound cue.

Participants were instructed to detect a small clockwise or counterclockwise rotation in the orientation of the grating at the attended location with respect to a base orientation at 45\textdegree~or 135\textdegree. The size of rotation offset was adjusted with an adaptive staircase procedure using QUEST \cite{Watson1983}, such that participants detected approximately 80\% of the offsets correctly. An overview of the experiment is shown in Fig.~\ref{fig:experiment}.

All but one participants completed 18 stimulus runs. The remaining participant completed 12 runs due to equipment failure.

Retinotopic maps of visual cortex were acquired in a separate scan session at a 3T scanner using conventional retinotopic mapping procedures \cite{Sereno1995,DeYoe1996,Engel1997}. 
\input{./Chapters/04_Attention/Chapters/Figures/FigureExperiment}

\subsection{MR data acquisition}
Functional images were acquired on a Magnetom Siemens 7T scanner with a 32-channel head coil (Nova Medical, Wilmington, USA) combined with dielectric pads \cite{Teeuwisse2012}, using a $T_2^*$-weigthed 3D gradient-echo EPI sequence \cite{Poser2010} (TR/TE/$\alpha$=3060 ms/20 ms/14\textdegree, 72 slices oriented orthogonally to the calcarine sulcus, voxel size [0.8 mm]$^3$, FOV: [192 mm]$^2 $, GRAPPA factor 8).

Gradient maximum amplitude was 40 mT/m (in practice, however, this maximum wasn't reached), the minimum gradient rise time was 200 $\mu$s, and the maximum slew rate was 200 T/m/s. Shimming was performed using the standard Siemens shimming procedure for 7T. There were 18 runs of 72 $\pm$ 4 volumes. As the lengths of the events and the inter trial interval were of unequal length, there was a small variation in the number of volumes per run.

Finger pulse was recorded using a pulse oximeter affixed to the index finger of the left hand. Respiration was measured using a respiration belt placed around the participant's abdomen.

Anatomical images were acquired using an MP2RAGE sequence \cite{Marques2010} [0.75 mm]$^3$, yielding two inversion contrasts (TR/TE/TI1/TI2 = 5000ms/1.89ms/900ms/3200m).

In a separate session prior to the main experiment, a retinotopy session was conducted at a Siemens 3T Magnetom Trio scanner. A high-resolution T$_1$-weighted anatomical scan was acquired (MPRAGE, FOV 256 $\times$ 256, 1 mm isotropic voxels) at the start of the session. Functional images were subsequently collected using T$_2^*$-weighted gradient echo EPI, in 30 slices oriented perpendicular to the calcarine sulcus (TR/TE/$\alpha$ = 2000 ms/30 ms/90\textdegree, FOV = 64 $\times$ 64, [2.2 mm]$^3$ isotropic resolution).


\subsection{Functional MRI preprocessing}
\subsubsection{Data preprocessing}
\label{sec:dataProcessing}
Data were corrected for subject motion using SPM with the mean functional volume across time as a reference \cite{Friston1995}. Residual motion-induced fluctuations in the BOLD signal were removed through linear regression, based on the alignment parameters of SPM. Scanner drifts were corrected via linear regression with high-pass filter regressors to filter out frequencies below 1/64 Hz. Pulsating signals as a result of the respiratory and cardiac cycle were removed as follows. The cardiac/respiratory peaks were automatically detected from the physiological recordings using in-house interactive peak-detection software, and manually corrected where needed. With a custom MATLAB implementation of RETROICOR \cite{Glover2000}, fifth order Fourier regressors were constructed for heart rate and respiration and subsequently removed from the functional images via linear regression. A small part (10\% of respiratory measurements, and 18\% of heart rate measurements) was of insufficient quality and could not be used in this analysis. Functional data for these time frames were used in the main analysis but uncorrected for cardiac and respiratory noise.

The functional and anatomical scans were brought to the same space by registering the anatomical surface from the retinotopy session to the mean functional volume using boundary based registration (BBR), implemented in FreeSurfer's \texttt{bbregister} \cite{Greve2009}. All registration results were inspected and manually refined when necessary. Where needed, registration was improved by an additional pass of BBR using an in-house MATLAB implementation. Local distortions in EPI due to field inhomogeneity were corrected by means of recursive boundary registration \cite{VanMourikISMRM2014}, which recursively applies BBR to small portions of the cortical surface to correct topology locally by means of optimizing the grey-white matter contrast along the surface.

Because of temporal changes in magnetic field inhomogeneities, local topology slightly changed over the course of the entire session. For this reason, the 18 functional runs obtained for each subject were first divided in three groups of each 6 contiguous runs, and then each group was pre-processed separately.  Time courses were subsequently concatenated before entering the main analyses.


\subsubsection{Regions of Interest}
Regions of interest (areas V1, V2, V3) were defined on the reconstructed cortical surface using standard retinotopic mapping procedures \cite{Sereno1995,DeYoe1996,Engel1997}. After identifying areas V1-V3, data were smoothed along the reconstructed cortical surface with a Gaussian kernel (FWHM: 4 mm). The smoothed version of the data was only used in region of interest selection, and not in the main analysis. In each area, we then selected the 600 vertices that responded most strongly to the stimulus (shown on the cortical surface in Supplementary Figure~\ref{SM5}). The selected vertices were resampled from the cortical surface back to subject space by means of FreeSurfer's \texttt{label2vol}. T-values of selected voxels ($\mu \pm \sigma$) were V1: $T=2,989 \pm 0.854$, V2: $T=2.317 \pm 0.689$ and V3: $T=2.117 \pm 0.713$). Note that the selection of voxels based on visual activation per se is orthogonal to the analysis of interest, which addresses the effects of attention on individual layers in cortex. Control analyses verified that our results were not strongly affected by the number of vertices selected for subsequent analysis (See Supplementary Figures).

\subsection{Cortical profile extraction}
Layer specific signals were obtained by means of a layer specific spatial General Linear Model (GLM) as proposed by \cite{VanMourikISMRM2015} and briefly described in \cite{Kok2016}. Specifically, we applied the level set method \cite{Sethian1999} on the reconstructed cortical surface \cite{Dale1999} to create a cortical layering of three equivolume layers, following the procedures described in \cite{Waehnert2014}. The gradient and the curvature of the cortex were defined as a function of Laplacian streamlines in the grey matter as this more naturally follows the structure of cortical columns \cite{Leprince2015}. Partial volume inaccuracies were adjusted for by explicitly taking into account the orientation of the voxel with respect to the cortex \cite{VanMourikISMRM2015}. This procedure enabled us to divide the gray matter in three equivolume cortical layers, which amounts to roughly one voxel per layer. We additionally defined a volume on either side of these three cortical layers to capture signals for white matter and cerebrospinal fluid. On the basis of  these definitions, we then created a laminar (spatial) design matrix. By regressing this design matrix against the functional data within an ROI, we obtained laminar time courses. In the regression, we used generalised least squares to account for spatial covariance in the noise. The voxel-to-voxel covariance matrix was defined based on Gaussian noise spread (FWHM 1.41 mm) between neighbouring voxels. 

\subsection{Statistical Analyses}
Temporal linear regression was used to compare between the experimental conditions. Regressors were created as follows. The stimuli appeared during the stimulus window on 2/3rds of trials, which were modeled with a single regressor (stimulus \emph{on}). The remaining stimulus windows were also modeled with a regressor (stimulus \emph{off}). In addition, attention could either be directed to the \emph{left} or \emph{right} visual field; these conditions were each modeled with a regressor. We so obtained four regressors for each of the conditions of interest. To remove any potential influence from the anticipation period, i.e. before stimulus presentation, we additionally included separate regressors for each of these four factors during the anticipation window. We used a canonical HRF (parameters: time-to-peak-parameter: 5 second) to model the fMRI responses. To verify the appropriateness of this function, a finite impulse response (FIR) analysis \cite{Josephs1997} was performed using the data from four pilot subjects (not included in the current study). Based on this pilot data set, temporal or dispersion derivatives were not included into the statistical model. The baseline signal of each run was captured by adding a regressor column of ones for each run separately. As described above (Sec.~\ref{sec:dataProcessing}), the data were pre-processed by means of nuisance regression. This was performed by adding the nuisance regressors to the design matrix, effectively adjusting for the statistical loss in degrees of freedom as a result of nuisance regression. The reference of one percent signal change was the height of a peak of a two-second-long isolated event \cite{Mumford2007}.

The temporal regression was performed on the previously extracted layer-specific time courses. The obtained parameter estimates were divided by their baseline estimates, in order to convert them to percent signal change. The values in percent signal were compared at the group level by means of ANOVAs and t-tests as appropriate. As the experiment was left-right symmetric and we found no differences between hemispheres in the analyses of interest, the hemispheres were treated as two measurements per participant.

\subsection{Code availability}
All functions for laminar analysis that are mentioned here are available on \url{https://github.com/TimVanMourik/OpenFmriAnalysis}. Custom analysis scripts are available on request. The analysis scripts were made with Porcupine pipeline software available on \url{http://timvanmourik.github.io/Porcupine} \cite{VanMourik2017}.


